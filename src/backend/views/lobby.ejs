<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Lobby</title>
    <link rel="stylesheet" href="/stylesheets/lobby.css" />
  </head>
  <body>
    <!-- HEADER -->
    <header class="header">
      <div class="header-title">
        <h1>Game Lobby</h1>
      </div>
      <div class="header-user">
        <span class="username">
          <% if (currentUser) { %>
            <%= currentUser.username %>
          <% } else { %>
            Guest
          <% } %>
        </span>
        <form action="/auth/logout" method="POST" style="display: inline;">
          <button type="submit" class="logout-btn">Log Out</button>
        </form>
      </div>
    </header>

    <main class="main">
      <!-- LOBBY GRID -->
      <section class="lobby-section">
        <div class="lobby-grid">
          <% if (!rooms || rooms.length === 0) { %>
            <p class="empty-lobby">No games yet. Create one!</p>
          <% } else { %>
            <% rooms.forEach(function (room) { %>
              <article class="lobby-card">
                <div class="lobby-card-top">
                  <span class="lobby-name">
                    <%= room.hostUsername %>'s Lobby
                  </span>
                  <span class="lobby-count">
                    <%= room.currentPlayers %>/<%= room.maxPlayers %>
                  </span>
                </div>

                <div class="lobby-card-bottom">
                  <% if (room.currentPlayers >= room.maxPlayers) { %>
                    <button class="join-btn" disabled>Full</button>
                  <% } else { %>
                    <form
                      action="/waiting_room/<%= room.id %>/join"
                      method="POST"
                    >
                      <% if (room.hasPassword) { %>
                        <button type="submit" class="join-btn">Join ðŸ”’</button>
                      <% } else { %>
                        <button type="submit" class="join-btn">Join</button>
                      <% } %>
                    </form>
                  <% } %>
                </div>
              </article>
            <% }) %>
          <% } %>
        </div>

        <div class="create-room-wrapper">
          <button class="create-room-btn" type="button">Create Room</button>
        </div>
      </section>

      <!-- CHAT PANEL  -->
      <aside class="chat-section" data-room-type="lobby">
        <div class="chat-header">Lobby Chat</div>

        <div class="chat-messages" id="chat-messages"></div>

        <form class="chat-input" id="chat-form">
          <input
            type="text"
            name="message"
            id="chat-input-field"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button type="submit">Send</button>
        </form>
      </aside>
    </main>

    <!-- CREATE ROOM MODAL -->
    <div id="create-room-modal" class="create-room-modal hidden">
      <form action="/lobby/create_game" method="POST" class="page">
        <header class="page-header">
          <h1>Create A Room</h1>
        </header>

        <main class="layout">
          <section class="column">
            <div class="section-label">Max Players</div>
            <div class="max-player-buttons">
              <button class="pill-button active" data-max="2" type="button">
                2 Players
              </button>
              <button class="pill-button" data-max="3" type="button">
                3 Players
              </button>
              <button class="pill-button" data-max="4" type="button">
                4 Players
              </button>
            </div>
          </section>

          <section class="column">
            <div class="section-label">Password</div>
            <button
              class="primary-button wide-button"
              type="button"
              id="set-room-password"
            >
              Set Room Password
            </button>
          </section>
        </main>

        <!-- hidden fields sent to /waiting_room -->
        <input type="hidden" name="title" value="">
        <input type="hidden" name="maxPlayers" id="maxPlayersInput" value="2">
        <input type="hidden" name="password" id="roomPasswordInput" value="">

        <footer class="page-footer">
          <div class="start-wrapper">
            <button type="submit" class="primary-button start-button">
              Create Room
            </button>
            <button
              id="close-modal"
              type="button"
              class="secondary-button start-button"
            >
              Cancel
            </button>
          </div>
        </footer>
      </form>
    </div>

    <!-- Script to toggle create room modal + set fields -->
    <script>
      const openBtn = document.querySelector(".create-room-btn");
      const modal = document.getElementById("create-room-modal");
      const closeBtn = document.getElementById("close-modal");

      if (openBtn && modal && closeBtn) {
        openBtn.addEventListener("click", (e) => {
          e.preventDefault();
          modal.classList.remove("hidden");
        });

        closeBtn.addEventListener("click", () => {
          modal.classList.add("hidden");
        });
      }

      // max players pills
      const pillButtons = document.querySelectorAll(".pill-button");
      const maxPlayersInput = document.getElementById("maxPlayersInput");

      pillButtons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          pillButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const max = btn.dataset.max;
          if (maxPlayersInput && max) {
            maxPlayersInput.value = max;
          }
        });
      });

      // password setter
      const passwordBtn = document.getElementById("set-room-password");
      const passwordInput = document.getElementById("roomPasswordInput");

      if (passwordBtn && passwordInput) {
        passwordBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const value = window.prompt(
            "Enter a room password (leave blank for none):",
            passwordInput.value || ""
          );
          if (value === null) return; // user cancelled
          passwordInput.value = value.trim();
        });
      }
    </script>

    <script src="/js/bundle.js"></script>
  </body>
</html>
