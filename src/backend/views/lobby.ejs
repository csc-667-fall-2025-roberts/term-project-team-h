<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Lobby</title>
    <link rel="stylesheet" href="/stylesheets/lobby.css" />
  </head>
  <body>
    <!-- HEADER -->
    <header class="header">
      <div class="header-title">
        <h1>Game Lobby</h1>
      </div>
      <div class="header-user">
        <span class="username">
          <% if (currentUser) { %>
            <%= currentUser.username %>
          <% } else { %>
            Guest
          <% } %>
        </span>
        <form action="/auth/logout" method="POST" style="display: inline;">
          <button type="submit" class="logout-btn">Log Out</button>
        </form>
      </div>
    </header>

    <main class="main lobby-page">
      <!-- LOBBY GRID -->
      <section class="lobby-section">
        <div class="lobby-grid">
          <% if (!rooms || rooms.length === 0) { %>
            <p class="empty-lobby">No games yet. Create one!</p>
          <% } else { %>
            <% rooms.forEach(function (room) { %>
              <article class="lobby-card"
                data-room-id="<%= room.id %>"
                data-has-password="<%= room.hasPassword %>">
                
                <div class="lobby-card-top">
                  <span class="lobby-name">
                    <%= room.hostUsername %>'s Lobby
                  </span>
                  <span class="lobby-count">
                    <%= room.currentPlayers %>/<%= room.maxPlayers %>
                  </span>
                </div>

                <div class="lobby-card-bottom">
                  <% if (room.currentPlayers >= room.maxPlayers) { %>
                    <button class="join-btn" disabled>Full</button>
                  <% } else { %>
                    <form 
                      action="/waiting_room/<%= room.id %>/join" 
                      method="POST" 
                      data-room-id="<%= room.id %>"
                    >
                    <button type="submit" class="join-btn">Join</button>
                    </form>
                  <% } %>
                </div>
              </article>
            <% }) %>
          <% } %>
        </div>

        <div class="create-room-wrapper">
          <button class="create-room-btn" type="button">Create Room</button>
        </div>
      </section>

      <!-- CHAT PANEL  -->
      <aside class="chat-section" data-room-type="lobby">
        <div class="chat-header">Lobby Chat</div>

        <div class="chat-messages" id="chat-messages"></div>

        <form class="chat-input" id="chat-form">
          <input
            type="text"
            name="message"
            id="chat-input-field"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button type="submit">Send</button>
        </form>
      </aside>
    </main>

    <!-- JOIN ROOM PASSWORD MODAL -->
    <div id="join-room-modal" class="join-room-modal hidden">
      <div class="join-room-card">
        <div class="join-room-header">
          <h2>Enter Room Password</h2>
        </div>
        <form id="join-room-form" method="POST">
          <div class="join-room-body">
            <input
              type="password"
              name="password"
              id="join-room-password"
              class="join-room-password-input"
              placeholder="Password"
              required
            />
            <div class="password-error hidden">Incorrect Password</div>
          </div>
          <div class="join-room-footer">
            <button type="submit" id="join-room-confirm" class="primary-button">
              Join
            </button>
            <button type="button" id="join-room-cancel" class="secondary-button">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- CREATE ROOM MODAL -->
    <div id="create-room-modal" class="create-room-modal hidden">
      <form action="/lobby/create_game" method="POST" class="page">
        <header class="page-header">
          <h1>Create A Room</h1>
        </header>

        <main class="layout">
          <section class="column">
            <div class="section-label">Max Players</div>
            <div class="max-player-buttons">
              <button class="pill-button active" data-max="2" type="button">
                2 Players
              </button>
              <button class="pill-button" data-max="3" type="button">
                3 Players
              </button>
              <button class="pill-button" data-max="4" type="button">
                4 Players
              </button>
            </div>
          </section>

          <section class="column">
            <div class="section-label">Password</div>
            <input 
              type="text"
              name="password"
              id="roomPasswordInput"
              class="create-psw"
              placeholder="Enter password (optional)"
            />
          </section>
        </main>

        <!-- hidden fields sent to /waiting_room -->
        <input type="hidden" name="title" value="">
        <input type="hidden" name="maxPlayers" id="maxPlayersInput" value="2">

        <footer class="page-footer">
          <div class="start-wrapper">
            <button type="submit" class="primary-button start-button">
              Create Room
            </button>
            <button
              id="close-modal"
              type="button"
              class="secondary-button start-button"
            >
              Cancel
            </button>
          </div>
        </footer>
      </form>
    </div>

    <!-- Script to toggle create room modal + set fields -->
    <script>
      // CREATE ROOM MODAL
      const openBtn = document.querySelector(".create-room-btn");
      const createModal = document.getElementById("create-room-modal");
      const closeBtn = document.getElementById("close-modal");

      if (openBtn && createModal && closeBtn) {
        openBtn.addEventListener("click", (e) => {
          e.preventDefault();
          createModal.classList.remove("hidden");
        });

        closeBtn.addEventListener("click", () => {
          createModal.classList.add("hidden");
        });
      }


      // MAX PLAYERS PILL BUTTONS
      const pillButtons = document.querySelectorAll(".pill-button");
      const maxPlayersInput = document.getElementById("maxPlayersInput");

      pillButtons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          pillButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const max = btn.dataset.max;
          if (maxPlayersInput && max) {
            maxPlayersInput.value = max;
          }
        });
      });

      // =========================
      // JOIN ROOM PASSWORD MODAL
      // =========================
      const joinModal = document.getElementById("join-room-modal");
      const joinForm = document.getElementById("join-room-form");
      const joinPasswordInput = document.getElementById("join-room-password");
      const joinCancelBtn = document.getElementById("join-room-cancel");
      const passwordError = document.querySelector(".password-error");

      const lobbyJoinForms = document.querySelectorAll(".lobby-card form");

      function openJoinModal(roomId) {
        if (!joinForm || !joinModal || !joinPasswordInput) return;

        joinPasswordInput.value = "";
        passwordError?.classList.add("hidden");
        if (passwordError) passwordError.textContent = "Incorrect Password";

        joinForm.setAttribute("action", `/waiting_room/${roomId}/join`);
        joinModal.classList.remove("hidden");
        joinPasswordInput.focus();
      }

      function closeJoinModal() {
        if (!joinModal || !joinPasswordInput) return;

        joinPasswordInput.value = "";
        passwordError?.classList.add("hidden");
        joinModal.classList.add("hidden");
      }

      // If room has password, prevent normal form submit and open modal
      lobbyJoinForms.forEach((form) => {
        form.addEventListener("submit", (e) => {
          const card = form.closest(".lobby-card");
          if (!card) return;

          const hasPassword = card.dataset.hasPassword === "true";
          const roomId = card.dataset.roomId;

          if (!hasPassword || !roomId) return;

          e.preventDefault();
          openJoinModal(roomId);
        });
      });

      // Cancel closes modal
      joinCancelBtn?.addEventListener("click", closeJoinModal);

      // Escape closes modal
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && joinModal && !joinModal.classList.contains("hidden")) {
          closeJoinModal();
        }
      });

      joinForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!joinForm || !joinPasswordInput) return;

        passwordError?.classList.add("hidden");

        const actionUrl = joinForm.getAttribute("action");
        if (!actionUrl) return;

        const password = joinPasswordInput.value;

        let res;
        try {
          res = await fetch(actionUrl, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ password }).toString(),
            credentials: "include",
          });
        } catch {
          if (passwordError) passwordError.textContent = "Network error";
          passwordError?.classList.remove("hidden");
          return;
        }

        // If backend returns JSON with redirect, use it
        const contentType = res.headers.get("content-type") || "";
        if (res.ok && contentType.includes("application/json")) {
          const data = await res.json().catch(() => null);
          if (data?.ok && data?.redirect) {
            window.location.href = data.redirect;
            return;
          }
        }

        // go to waiting room page
        if (res.ok) {
          window.location.href = actionUrl.replace(/\/join$/, "");
          return;
        }

        // Wrong password
        if (res.status === 401 || res.status === 403) {
          if (passwordError) passwordError.textContent = "Incorrect Password";
          passwordError?.classList.remove("hidden");
          joinPasswordInput.focus();
          joinPasswordInput.select();
          return;
        }

        // Other server error
        if (passwordError) passwordError.textContent = "Unable to join room";
        passwordError?.classList.remove("hidden");
      });
    </script>

    <script src="/js/bundle.js"></script>
  </body>
</html>
